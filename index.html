<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shah Commerce College - Professional Fees Voucher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a3a6e;
            --secondary: #2c56a0;
            --accent: #4a89dc;
            --paid: #28a745;
            --unpaid: #dc3545;
            --new-student: #17a2b8;
            --existing-student: #6c757d;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        /* Preloader */
        .preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .preloader-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(26, 58, 110, 0.1);
            border-top: 6px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        /* Main Content */
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .college-logo {
            height: 80px;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        
        .college-logo:hover {
            transform: scale(1.05);
        }
        
        .form-container {
            padding: 30px;
        }
        
        /* Toggle Buttons */
        .toggle-group {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .toggle-group .btn {
            border-radius: 0;
            position: relative;
            flex: 1;
            transition: all 0.3s ease;
        }
        
        .toggle-group .btn:first-child {
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }
        
        .toggle-group .btn:last-child {
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        
        .toggle-group .btn.active {
            font-weight: 600;
            color: white;
        }
        
        /* Additional Charges */
        .additional-charges {
            margin-top: 15px;
        }
        
        .charge-item {
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        /* Voucher Styles */
        .voucher-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }
        
        .watermark {
            position: absolute;
            opacity: 0.05;
            font-size: 120px;
            font-weight: bold;
            color: var(--primary);
            transform: rotate(-30deg);
            top: 30%;
            left: 10%;
            z-index: 0;
        }
        
        /* Status Badges */
        .badge-paid {
            background-color: var(--paid);
            color: white;
        }
        
        .badge-unpaid {
            background-color: var(--unpaid);
            color: white;
        }
        
        .badge-new {
            background-color: var(--new-student);
            color: white;
        }
        
        .badge-existing {
            background-color: var(--existing-student);
            color: white;
        }
        
        /* Designer Name Styling */
        .designer-name {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        .designer-name:hover {
            color: var(--secondary);
            text-decoration: underline;
            transform: scale(1.05);
        }
        
        /* Search Bar Styling */
        .search-container {
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        /* Student Records Table */
        .records-table {
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }
        
        /* Action Buttons */
        .action-btn {
            transition: all 0.3s ease;
            margin: 0 5px;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
        }
        
        /* Responsive Fixes */
        @media (max-width: 768px) {
            .header {
                padding: 20px 15px;
            }
            .college-logo {
                height: 60px;
            }
            .form-container {
                padding: 20px;
            }
            .voucher-container {
                padding: 20px;
            }
            .btn-group {
                width: 100%;
            }
            .action-buttons .btn {
                margin-bottom: 10px;
                width: 100%;
            }
            .designer-name {
                font-size: 1rem;
            }
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Print specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #voucherContent, #voucherContent * {
                visibility: visible;
            }
            #voucherContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
            }
            .no-print {
                display: none !important;
            }
            .watermark {
                opacity: 0.1 !important;
            }
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }
        
        /* Tab Navigation */
        .nav-tabs .nav-link {
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            transform: translateY(-2px);
        }
        
        /* Table Row Animation */
        .table-row {
            transition: all 0.3s ease;
        }
        
        .table-row:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Refresh Button */
        .refresh-btn {
            animation: spin 2s linear infinite;
        }
        
        /* Form Input Animation */
        .form-control {
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 0.25rem rgba(26, 58, 110, 0.25);
        }
        
        /* Improved Screenshot Quality */
        #voucherContent {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            box-sizing: border-box;
        }
        
        @media print {
            #voucherContent {
                width: 100%;
                padding: 20px;
            }
        }

        /* Perfect screenshot styles */
        .screenshot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        
        .screenshot-voucher {
            background: white !important;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            box-shadow: none !important;
            transform: none !important;
            animation: none !important;
        }
        
        .screenshot-voucher * {
            color: #333 !important;
        }
        
        .screenshot-voucher .badge {
            color: white !important;
        }
        
        .screenshot-voucher .watermark {
            opacity: 0.08 !important;
            color: rgba(26, 58, 110, 0.1) !important;
        }
        
        .screenshot-voucher img {
            opacity: 1 !important;
        }
        
        /* Ensure status badges are visible */
        .screenshot-voucher .badge-paid {
            background-color: #28a745 !important;
        }
        
        .screenshot-voucher .badge-unpaid {
            background-color: #dc3545 !important;
        }
        
        .screenshot-voucher .badge-new {
            background-color: #17a2b8 !important;
        }
        
        .screenshot-voucher .badge-existing {
            background-color: #6c757d !important;
        }
    </style>
</head>
<body>
    <!-- Preloader -->
    <div class="preloader" id="preloader">
        <div class="preloader-spinner"></div>
        <h5 class="animate__animated animate__fadeIn">Shah Commerce College</h5>
        <p class="animate__animated animate__fadeIn animate__delay-1s">Loading voucher system...</p>
        <small class="animate__animated animate__fadeIn animate__delay-2s">Designed by <span class="designer-name">Syed Ghina ul Hassan</span></small>
    </div>

    <!-- Main Content -->
    <div class="container py-4" id="mainContent" style="display:none;">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card animate__animated animate__fadeIn">
                    <div class="header">
                        <img src="./assets/ssc24.png" alt="Shah Commerce College Logo" class="college-logo">
                        <h3>Shah Commerce College</h3>
                        <p>Gulshan Campus - Fees Voucher System</p>
                    </div>
                    
                    <div class="form-container">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate" type="button" role="tab">Generate Voucher</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="records-tab" data-bs-toggle="tab" data-bs-target="#records" type="button" role="tab">Student Records</button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="myTabContent">
                            <!-- Generate Voucher Tab -->
                            <div class="tab-pane fade show active" id="generate" role="tabpanel">
                                <form id="voucherForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Student Name</label>
                                            <input type="text" class="form-control" id="studentName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Father's Name</label>
                                            <input type="text" class="form-control" id="fatherName" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Class</label>
                                            <input type="text" class="form-control" id="className" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fee Amount (PKR)</label>
                                            <input type="number" class="form-control" id="feeAmount" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Fee Month</label>
                                            <select class="form-select" id="feeMonth" required>
                                                <option value="">Select Month</option>
                                                <option value="January">January</option>
                                                <option value="February">February</option>
                                                <option value="March">March</option>
                                                <option value="April">April</option>
                                                <option value="May">May</option>
                                                <option value="June">June</option>
                                                <option value="July">July</option>
                                                <option value="August">August</option>
                                                <option value="September">September</option>
                                                <option value="October">October</option>
                                                <option value="November">November</option>
                                                <option value="December">December</option>
                                                <option value="Annual">Annual Charges</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="dueDate" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Payment Status</label>
                                            <select class="form-select" id="paymentStatus" required>
                                                <option value="Paid">Paid</option>
                                                <option value="Unpaid">Unpaid</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <!-- Additional Charges -->
                                    <div class="additional-charges">
                                        <h6>Additional Charges</h6>
                                        <div class="charge-item">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" placeholder="Charge Description" id="chargeDesc1">
                                                <input type="number" class="form-control" placeholder="Amount (PKR)" id="chargeAmount1">
                                            </div>
                                        </div>
                                        <div class="charge-item">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control" placeholder="Charge Description" id="chargeDesc2">
                                                <input type="number" class="form-control" placeholder="Amount (PKR)" id="chargeAmount2">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="addChargeBtn">
                                            <i class="fas fa-plus"></i> Add More Charges
                                        </button>
                                    </div>
                                    
                                    <div class="text-center mt-3">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-file-invoice-dollar"></i> Generate Voucher
                                        </button>
                                    </div>
                                </form>
                                
                                <div id="voucherPreview" style="display:none;">
                                    <div class="voucher-container" id="voucherContent">
                                        <div class="watermark">Shah Commerce</div>
                                        <div class="text-center mb-4">
                                            <img src="./assets/ssc24.png" class="college-logo">
                                            <h4>Shah Commerce College</h4>
                                            <p>Gulshan Campus</p>
                                            <h5 class="mt-3">FEE VOUCHER</h5>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Voucher No:</strong> <span id="voucherNo">SC-2023-001</span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Date:</strong> <span id="voucherDate"></span>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <strong>Student Name:</strong> <span id="displayName"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Father's Name:</strong> <span id="displayFatherName"></span>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <strong>Class:</strong> <span id="displayClass"></span>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <strong>Fee Month:</strong> <span id="displayMonth"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Due Date:</strong> <span id="displayDueDate"></span>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <strong>Status:</strong> <span class="badge" id="displayPaymentStatus">Paid</span>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Generated On:</strong> <span id="generatedDate"></span>
                                            </div>
                                        </div>
                                        
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Description</th>
                                                    <th>Amount (PKR)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="feeTableBody">
                                                <tr>
                                                    <td>Tuition Fee</td>
                                                    <td id="displayAmount"></td>
                                                </tr>
                                                <!-- Additional charges will be added here -->
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td><strong>Total Payable</strong></td>
                                                    <td><strong id="totalAmount"></strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                        
                                        <div class="mt-4 p-3 bg-light rounded">
                                            <p><strong>Payment Instructions:</strong></p>
                                            <ul>
                                                <li>Pay before due date to avoid late charges</li>
                                                <li>Computer generated - no signature needed</li>
                                            </ul>
                                        </div>
                                        
                                        <div class="text-center mt-4">
                                            <div style="width: 200px; border-top: 1px solid #333; margin: 0 auto 10px; padding-top: 5px;">
                                                Authorized Signature
                                            </div>
                                            <small class="text-muted">Computer generated voucher</small>
                                        </div>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button id="screenshotBtn" class="btn btn-info">
                                            <i class="fas fa-camera"></i> Take Screenshot
                                        </button>
                                        <button id="printBtn" class="btn btn-primary">
                                            <i class="fas fa-print"></i> Print Voucher
                                        </button>
                                        <button id="refreshBtn" class="btn btn-warning">
                                            <i class="fas fa-sync-alt"></i> Refresh Form
                                        </button>
                                        <button id="backBtn" class="btn btn-secondary no-print" style="display:none;">
                                            <i class="fas fa-arrow-left"></i> Back to Form
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Student Records Tab -->
                            <div class="tab-pane fade" id="records" role="tabpanel">
                                <div class="search-container">
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                        <button class="btn btn-outline-danger" type="button" id="clearSearchBtn">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                        <button class="btn btn-outline-primary" type="button" id="refreshRecordsBtn">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive records-table">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Voucher No</th>
                                                <th>Student Name</th>
                                                <th>Class</th>
                                                <th>Fee Month</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recordsTableBody">
                                            <!-- Records will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-muted animate__animated animate__fadeIn">
                    <small>Designed by <span class="designer-name">Syed Ghina ul Hassan</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="preloader" id="loadingScreen" style="display:none;">
        <div class="preloader-spinner"></div>
        <h5>Generating Voucher</h5>
        <p>Please wait...</p>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this record? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-success text-white">
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                Operation completed successfully!
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    
    <script>
        // Student records database
        let studentRecords = JSON.parse(localStorage.getItem('studentRecords')) || [];
        let recordToDelete = null;
        let currentVoucher = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap components
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const successToast = new bootstrap.Toast(document.getElementById('successToast'));
            
            // Show preloader for 9 seconds
            setTimeout(() => {
                document.getElementById('preloader').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                updateRecordsTable();
            }, 9000); // Changed from 2000 to 9000 for 9 seconds loading
            
            // Initialize variables
            let chargeCount = 2;
            
            // Set current date and default due date (7 days from today)
            const today = new Date();
            const defaultDueDate = new Date();
            defaultDueDate.setDate(today.getDate() + 7);
            
            document.getElementById('voucherDate').textContent = formatDate(today);
            document.getElementById('dueDate').valueAsDate = defaultDueDate;
            document.getElementById('displayDueDate').textContent = formatDate(defaultDueDate);
            document.getElementById('generatedDate').textContent = formatDateTime(today);
            
            // Generate random voucher number
            const randomNum = Math.floor(1000 + Math.random() * 9000);
            const voucherNumber = `SC-${today.getFullYear()}-${randomNum}`;
            document.getElementById('voucherNo').textContent = voucherNumber;
            
            // Form submission
            document.getElementById('voucherForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate form
                const studentName = document.getElementById('studentName').value;
                const fatherName = document.getElementById('fatherName').value;
                const className = document.getElementById('className').value;
                const feeAmount = document.getElementById('feeAmount').value;
                const feeMonth = document.getElementById('feeMonth').value;
                const dueDate = document.getElementById('dueDate').value;
                const paymentStatus = document.getElementById('paymentStatus').value;
                
                if(!studentName || !fatherName || !className || !feeAmount || !feeMonth || !dueDate) {
                    alert('Please fill all required fields');
                    return;
                }
                
                // Show loading screen
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // Process after 1 second
                setTimeout(() => {
                    // Update voucher
                    document.getElementById('displayName').textContent = studentName;
                    document.getElementById('displayFatherName').textContent = fatherName;
                    document.getElementById('displayClass').textContent = className;
                    document.getElementById('displayMonth').textContent = feeMonth;
                    
                    // Format selected due date
                    const selectedDueDate = new Date(dueDate);
                    document.getElementById('displayDueDate').textContent = formatDate(selectedDueDate);
                    
                    // Update payment status
                    const statusBadge = document.getElementById('displayPaymentStatus');
                    statusBadge.textContent = paymentStatus;
                    statusBadge.className = 'badge ' + (paymentStatus === 'Paid' ? 'badge-paid' : 'badge-unpaid');
                    
                    // Update fee table
                    const feeTableBody = document.getElementById('feeTableBody');
                    feeTableBody.innerHTML = '';
                    
                    // Add tuition fee
                    addFeeRow(feeTableBody, 'Tuition Fee', feeAmount);
                    
                    // Add additional charges
                    let totalCharges = parseFloat(feeAmount);
                    
                    for(let i = 1; i <= chargeCount; i++) {
                        const desc = document.getElementById(`chargeDesc${i}`);
                        const amount = document.getElementById(`chargeAmount${i}`);
                        
                        if(desc && amount && desc.value && amount.value) {
                            addFeeRow(feeTableBody, desc.value, amount.value);
                            totalCharges += parseFloat(amount.value);
                        }
                    }
                    
                    // Update total amount
                    const totalAmount = totalCharges.toFixed(2);
                    document.getElementById('totalAmount').textContent = numberWithCommas(totalAmount);
                    
                    // Add to student records
                    const record = {
                        voucherNo: voucherNumber,
                        studentName: studentName,
                        fatherName: fatherName,
                        className: className,
                        feeMonth: feeMonth,
                        amount: totalAmount,
                        status: paymentStatus,
                        generatedOn: formatDateTime(today),
                        charges: getAdditionalCharges()
                    };
                    
                    // Check if this is an update to existing record
                    const existingIndex = studentRecords.findIndex(r => r.voucherNo === voucherNumber);
                    if(existingIndex >= 0) {
                        studentRecords[existingIndex] = record;
                    } else {
                        studentRecords.push(record);
                    }
                    
                    saveRecords();
                    updateRecordsTable();
                    
                    // Set current voucher
                    currentVoucher = voucherNumber;
                    
                    // Hide loading and show voucher
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('voucherPreview').style.display = 'block';
                    
                    // Scroll to voucher
                    document.getElementById('voucherPreview').scrollIntoView({ behavior: 'smooth' });
                    
                    // Show success message
                    successToast.show();
                }, 1000);
            });
            
            // Get additional charges from form
            function getAdditionalCharges() {
                const charges = [];
                for(let i = 1; i <= chargeCount; i++) {
                    const desc = document.getElementById(`chargeDesc${i}`);
                    const amount = document.getElementById(`chargeAmount${i}`);
                    
                    if(desc && amount && desc.value && amount.value) {
                        charges.push({
                            description: desc.value,
                            amount: amount.value
                        });
                    }
                }
                return charges;
            }
            
            // Perfect Screenshot Solution with Status Fix
            document.getElementById('screenshotBtn').addEventListener('click', async function() {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturing...';
                btn.disabled = true;
                
                // Create overlay for screenshot
                const overlay = document.createElement('div');
                overlay.className = 'screenshot-overlay';
                
                // Clone the voucher
                const voucher = document.getElementById('voucherContent');
                const clone = voucher.cloneNode(true);
                clone.classList.add('screenshot-voucher');
                
                // Fix images in the clone
                const images = clone.querySelectorAll('img');
                images.forEach(img => {
                    if (img.complete && img.naturalHeight !== 0) {
                        img.style.opacity = '1';
                    }
                });
                
                // Force status badges to be visible
                const badges = clone.querySelectorAll('.badge');
                badges.forEach(badge => {
                    badge.style.opacity = '1';
                    badge.style.color = 'white';
                });
                
                // Add to overlay
                overlay.appendChild(clone);
                document.body.appendChild(overlay);
                
                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));
                
                try {
                    const options = {
                        scale: 2, // Perfect balance of quality and size
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: clone.scrollWidth,
                        windowHeight: clone.scrollHeight,
                        backgroundColor: '#FFFFFF',
                        letterRendering: true,
                        quality: 1,
                        ignoreElements: (el) => el.classList.contains('no-print')
                    };
                    
                    // Capture the screenshot
                    const canvas = await html2canvas(clone, options);
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `fee_voucher_${document.getElementById('voucherNo').textContent}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    
                    // Trigger download
                    link.click();
                    
                    // Show success message
                    successToast.show();
                } catch (error) {
                    console.error('Screenshot error:', error);
                    alert('Error capturing screenshot. Please try again in Chrome browser.');
                } finally {
                    // Clean up
                    document.body.removeChild(overlay);
                    btn.innerHTML = '<i class="fas fa-camera"></i> Take Screenshot';
                    btn.disabled = false;
                }
            });
            
            // Print Function
            document.getElementById('printBtn').addEventListener('click', function() {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                btn.disabled = true;
                
                // Show back button
                document.getElementById('backBtn').style.display = 'block';
                
                // Hide other buttons temporarily
                document.getElementById('screenshotBtn').style.display = 'none';
                this.style.display = 'none';
                
                setTimeout(() => {
                    window.print();
                    
                    // Restore buttons after print
                    setTimeout(() => {
                        btn.innerHTML = '<i class="fas fa-print"></i> Print Voucher';
                        btn.disabled = false;
                        document.getElementById('screenshotBtn').style.display = 'block';
                        this.style.display = 'block';
                    }, 500);
                }, 500);
            });
            
            // Back button functionality
            document.getElementById('backBtn').addEventListener('click', function() {
                document.getElementById('voucherPreview').style.display = 'none';
                this.style.display = 'none';
                
                // Show all buttons again
                document.getElementById('screenshotBtn').style.display = 'block';
                document.getElementById('printBtn').style.display = 'block';
            });
            
            // Refresh form button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
                
                // Reset form
                document.getElementById('voucherForm').reset();
                document.getElementById('voucherPreview').style.display = 'none';
                
                // Remove additional charges
                for(let i = 3; i <= chargeCount; i++) {
                    const chargeItem = document.getElementById(`chargeItem${i}`);
                    if(chargeItem) chargeItem.remove();
                }
                chargeCount = 2;
                
                // Generate new voucher number
                const today = new Date();
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                const voucherNumber = `SC-${today.getFullYear()}-${randomNum}`;
                document.getElementById('voucherNo').textContent = voucherNumber;
                
                // Set default due date
                const defaultDueDate = new Date();
                defaultDueDate.setDate(today.getDate() + 7);
                document.getElementById('dueDate').valueAsDate = defaultDueDate;
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Form';
                    successToast.show();
                }, 1000);
            });
            
            // Add more charges
            document.getElementById('addChargeBtn').addEventListener('click', function() {
                chargeCount++;
                const newCharge = `
                    <div class="charge-item animate__animated animate__fadeIn" id="chargeItem${chargeCount}">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" placeholder="Charge Description" id="chargeDesc${chargeCount}">
                            <input type="number" class="form-control" placeholder="Amount (PKR)" id="chargeAmount${chargeCount}">
                            <button type="button" class="btn btn-outline-danger" onclick="document.getElementById('chargeItem${chargeCount}').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                document.querySelector('.additional-charges').insertAdjacentHTML('beforeend', newCharge);
            });
            
            // Search functionality
            document.getElementById('searchBtn').addEventListener('click', function() {
                searchRecords();
            });
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if(e.key === 'Enter') {
                    searchRecords();
                }
            });
            
            // Clear search functionality
            document.getElementById('clearSearchBtn').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                updateRecordsTable();
                successToast.show();
            });
            
            // Refresh records button
            document.getElementById('refreshRecordsBtn').addEventListener('click', function() {
                const btn = this;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                updateRecordsTable();
                
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                    successToast.show();
                }, 1000);
            });
            
            // Confirm delete
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                if(recordToDelete !== null) {
                    studentRecords = studentRecords.filter(record => record.voucherNo !== recordToDelete);
                    saveRecords();
                    updateRecordsTable();
                    confirmModal.hide();
                    successToast.show();
                    recordToDelete = null;
                }
            });
            
            // Helper functions
            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            function formatDateTime(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            }
            
            function numberWithCommas(x) {
                return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
            
            function addFeeRow(table, description, amount) {
                const row = table.insertRow();
                const descCell = row.insertCell(0);
                const amountCell = row.insertCell(1);
                
                descCell.textContent = description;
                amountCell.textContent = numberWithCommas(amount);
            }
            
            function saveRecords() {
                localStorage.setItem('studentRecords', JSON.stringify(studentRecords));
            }
            
            function updateRecordsTable() {
                const tableBody = document.getElementById('recordsTableBody');
                tableBody.innerHTML = '';
                
                if(studentRecords.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 7;
                    cell.textContent = 'No records found';
                    cell.className = 'text-center py-4';
                    return;
                }
                
                studentRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'table-row animate__animated animate__fadeIn';
                    
                    row.innerHTML = `
                        <td>${record.voucherNo}</td>
                        <td>${record.studentName}</td>
                        <td>${record.className}</td>
                        <td>${record.feeMonth}</td>
                        <td>${numberWithCommas(record.amount)}</td>
                        <td><span class="badge ${record.status === 'Paid' ? 'badge-paid' : 'badge-unpaid'}">${record.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info action-btn view-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning action-btn edit-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-primary action-btn print-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-success action-btn screenshot-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-sm btn-danger action-btn delete-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        viewRecord(voucherNo);
                    });
                });
                
                // Edit button functionality
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        editRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.print-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        printRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.screenshot-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        screenshotRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        recordToDelete = this.getAttribute('data-voucher');
                        confirmModal.show();
                    });
                });
            }
            
            // View record function
            function viewRecord(voucherNo) {
                const record = studentRecords.find(r => r.voucherNo === voucherNo);
                if(!record) return;
                
                // Fill the form with record data
                document.getElementById('studentName').value = record.studentName;
                document.getElementById('fatherName').value = record.fatherName;
                document.getElementById('className').value = record.className;
                document.getElementById('feeAmount').value = record.amount;
                document.getElementById('feeMonth').value = record.feeMonth;
                document.getElementById('paymentStatus').value = record.status;
                
                // Set voucher number
                document.getElementById('voucherNo').textContent = voucherNo;
                currentVoucher = voucherNo;
                
                // Switch to generate tab
                document.getElementById('generate-tab').click();
                
                // Show success message
                successToast.show();
            }
            
            // Edit record function
            function editRecord(voucherNo) {
                const record = studentRecords.find(r => r.voucherNo === voucherNo);
                if(!record) return;
                
                // Fill the form with record data
                document.getElementById('studentName').value = record.studentName;
                document.getElementById('fatherName').value = record.fatherName;
                document.getElementById('className').value = record.className;
                document.getElementById('feeAmount').value = record.amount;
                document.getElementById('feeMonth').value = record.feeMonth;
                document.getElementById('paymentStatus').value = record.status;
                
                // Set voucher number to existing one (for update)
                document.getElementById('voucherNo').textContent = voucherNo;
                currentVoucher = voucherNo;
                
                // Switch to generate tab
                document.getElementById('generate-tab').click();
                
                // Show success message
                successToast.show();
            }
            
            // Print record function
            function printRecord(voucherNo) {
                const record = studentRecords.find(r => r.voucherNo === voucherNo);
                if(!record) return;
                
                // Update voucher preview with record data
                document.getElementById('displayName').textContent = record.studentName;
                document.getElementById('displayFatherName').textContent = record.fatherName;
                document.getElementById('displayClass').textContent = record.className;
                document.getElementById('displayMonth').textContent = record.feeMonth;
                document.getElementById('voucherNo').textContent = record.voucherNo;
                
                // Update payment status
                const statusBadge = document.getElementById('displayPaymentStatus');
                statusBadge.textContent = record.status;
                statusBadge.className = 'badge ' + (record.status === 'Paid' ? 'badge-paid' : 'badge-unpaid');
                
                // Update fee table
                const feeTableBody = document.getElementById('feeTableBody');
                feeTableBody.innerHTML = '';
                
                // Add tuition fee
                addFeeRow(feeTableBody, 'Tuition Fee', record.amount);
                
                // Add additional charges if they exist
                if(record.charges && record.charges.length > 0) {
                    record.charges.forEach(charge => {
                        addFeeRow(feeTableBody, charge.description, charge.amount);
                    });
                }
                
                // Update total amount
                document.getElementById('totalAmount').textContent = numberWithCommas(record.amount);
                
                // Show voucher preview
                document.getElementById('voucherPreview').style.display = 'block';
                
                // Trigger print after a short delay
                setTimeout(() => {
                    document.getElementById('printBtn').click();
                }, 500);
            }
            
            // Screenshot record function
            async function screenshotRecord(voucherNo) {
                const record = studentRecords.find(r => r.voucherNo === voucherNo);
                if(!record) return;
                
                // Update voucher preview with record data
                document.getElementById('displayName').textContent = record.studentName;
                document.getElementById('displayFatherName').textContent = record.fatherName;
                document.getElementById('displayClass').textContent = record.className;
                document.getElementById('displayMonth').textContent = record.feeMonth;
                document.getElementById('voucherNo').textContent = record.voucherNo;
                
                // Update payment status
                const statusBadge = document.getElementById('displayPaymentStatus');
                statusBadge.textContent = record.status;
                statusBadge.className = 'badge ' + (record.status === 'Paid' ? 'badge-paid' : 'badge-unpaid');
                
                // Update fee table
                const feeTableBody = document.getElementById('feeTableBody');
                feeTableBody.innerHTML = '';
                
                // Add tuition fee
                addFeeRow(feeTableBody, 'Tuition Fee', record.amount);
                
                // Add additional charges if they exist
                if(record.charges && record.charges.length > 0) {
                    record.charges.forEach(charge => {
                        addFeeRow(feeTableBody, charge.description, charge.amount);
                    });
                }
                
                // Update total amount
                document.getElementById('totalAmount').textContent = numberWithCommas(record.amount);
                
                // Show voucher preview
                document.getElementById('voucherPreview').style.display = 'block';
                
                // Trigger screenshot after a short delay
                setTimeout(() => {
                    document.getElementById('screenshotBtn').click();
                }, 500);
            }
            
            function searchRecords() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filteredRecords = studentRecords.filter(record => 
                    record.studentName.toLowerCase().includes(searchTerm) || 
                    record.voucherNo.toLowerCase().includes(searchTerm) ||
                    record.className.toLowerCase().includes(searchTerm)
                );
                
                const tableBody = document.getElementById('recordsTableBody');
                tableBody.innerHTML = '';
                
                if(filteredRecords.length === 0) {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell(0);
                    cell.colSpan = 7;
                    cell.textContent = 'No matching records found';
                    cell.className = 'text-center py-4';
                    return;
                }
                
                filteredRecords.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'table-row animate__animated animate__fadeIn';
                    
                    row.innerHTML = `
                        <td>${record.voucherNo}</td>
                        <td>${record.studentName}</td>
                        <td>${record.className}</td>
                        <td>${record.feeMonth}</td>
                        <td>${numberWithCommas(record.amount)}</td>
                        <td><span class="badge ${record.status === 'Paid' ? 'badge-paid' : 'badge-unpaid'}">${record.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info action-btn view-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning action-btn edit-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-primary action-btn print-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-success action-btn screenshot-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-sm btn-danger action-btn delete-btn" data-voucher="${record.voucherNo}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        viewRecord(voucherNo);
                    });
                });
                
                // Edit button functionality
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        editRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.print-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        printRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.screenshot-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const voucherNo = this.getAttribute('data-voucher');
                        screenshotRecord(voucherNo);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        recordToDelete = this.getAttribute('data-voucher');
                        confirmModal.show();
                    });
                });
            }
        });
    </script>
    
</body>
</html>